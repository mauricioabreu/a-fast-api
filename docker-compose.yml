services:
  api1: &api
    container_name: api1
    build: .
    ports:
      - "80"
    depends_on:
      - db
    volumes:
      - .:/app
    working_dir: /app
    environment:
      - POSTGRES_USER=afastapi
      - POSTGRES_PASSWORD=afastapi
      - POSTGRES_DB=afastapi
  api2:
    <<: *api
    container_name: api2
  lb:
    sysctls:
      net.core.somaxconn: 4096
    container_name: lb
    image: nginx:latest
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api1
      - api2
    ports:
      - "9999:9999"
  db:
    container_name: db
    image: postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=afastapi
      - POSTGRES_PASSWORD=afastapi
      - POSTGRES_DB=afastapi
    volumes:
      - ./schema.sql:/docker-entrypoint-initdb.d/schema.sql
    command: "postgres -c max_connections=200 -c shared_buffers=256MB -c synchronous_commit=off -c fsync=off -c full_page_writes=off"
